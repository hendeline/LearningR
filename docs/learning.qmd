---
title: "Reproducible Document"
author: "Line Sahlholdt Hansen"
format: html
---

Quarto er en slags ny "R markdown" - Quarto er nyt, så det henvises somme tider til som R markdown stadig.
I Quarto er tekst ikke læst som kode (som normalt i R). Det virker ikke bare at skrive kode som tekst i R. Den læser det ikke som kode, når man er i Quarto. Man skal derfor indsætte en "code chunk", som indsættes ved at finde den ved at søge i menuen, som kommer frem ved at skrive "cmnd+shift+p". 

Under "format" øverst i dokumentet kan skiftes mellem "html", "docx" og "pdf" - det ændrer hvordan outputtet vises, når man trykker gem og derefter "Render". 

Under tandhjulikonet kan visningen af dokumentet ændres - fx enten på hjemmeside eller bare i siden af R. 
"Help" --> "keyboard shortcut help" giver oversigt over genveje. 

Code chunks kan navngives som fx herunder "r setup", og navne kan ikke genbruges i samme dokument. Kan ses under "outline" som kursiv tekst. "Overskrifterne" er lavet med fx ## (se sektion 15.8 for flere formateringsmuligheder).

"option + i" = |
```{r setup}
#| message: false
#| warning: false
library(tidyverse)

post_meal_data <- read_csv2(here::here("data/post-meal-insulin.csv"))

small_post_meal_data <- select(post_meal_data, id, Age, BMI, Group, auc_pg, auc_ins, glykemi)

tidier_post_meal_data <- small_post_meal_data |>
  rename(
    auc_glucose = auc_pg,
    auc_insulin = auc_ins
  ) |>
  filter(glykemi == 0) |>
  select(-glykemi)
tidier_post_meal_data

tidied_post_meal_data <- tidier_post_meal_data |>
  mutate(
    insulin_glucose_ratio = auc_insulin / auc_glucose,
    Group = if_else(Group == "CTR", "Control", "First degree relative")
  )
```

Linje med small_post_meal - gjort under sektion 20:
Vi vil nu lave en ny variabel/dataframe i datasættet. Kommer ud i environment og laver nyt datasæt med de variable, som man vælger. I undervisningen skriver de denne linje under "setup" chunk (har jeg også gjort) - gør dette ved eget datasæt, fordi denne altid kører som noget af det første, når man arbejder i programmet. 
Kører denne i setup: "small_post_meal_data <- select(post_meal_data, id, Age, BMI, Group, auc_pg, auc_ins, glykemi)"

Linje med tidier - gjort under sektion 20:
Gør sådan at de omdøbte kolonner kommer i datasættet og ikke bare outputtet. Gøres i setup-chunk. Gør dette i setup-chunk i eget datasæt også - sikrer at ændringerne indlæses som noget af det første. Omdøber nogle af tingene i det lille datasæt. Det er koden, der starter med "tidier".

## Writing R code

```{r}
2 + 2
```

Mange funktioner er ikke default-funktioner i R, når man åbner det. Actions/funktioner kan hentes i pakker. 


Alt i R er et "object", og man kan selv oprette objekter ved at "tildele" noget med "<-":

weight_kilos <- 100
weight_kilos

Der findes forskellige typer datatyper. Se "15.6" i undervisningsmateriale. 
Når man skriver "" betyder det, at man leder efter ...?


Functions (markeres med parentes ()) i R er noget, der giver en "action" - man gør noget med noget.
Prøver head-action herunder:

head(airquality)
head


------------ Exercise 15.9 -----------

## About me
- Line Sahlholdt Hansen
- Steno Diabetes Center Aarhus
- Aarhus Universitet

I am a **PhD student** conducting a study on *optimizing follow up after pregnancies affected by gestational diabetes*. 

## Simple code
```{r}
3 * 3
```

----------- Punkt 16: Version control with Git ------------

Git kan bruges til at registrere/logge ændringer løbende, så man ikke ender med mange versioner af et dokument. 
Klik "git" --> "commit". Kan skrive under "commmit message" hvorfor man ændrer noget. Før man kan gøre det, skal man vælge hvilke filer, man vil tracke ved at "add"e dem. Sæt fluben ved dokumentet og vælg "commit", tror jeg - se online i undervisningsdokument. 

Man kan bruge gitignore til fx personfølsomme dokumenter mv. Man kan bruge denne funktion til at definere hvilke dokumenter, der er tale om: usethis::use_git_ignore(c("*.html", "*_files/"))
Hermed har man sagt, at filer af denne type skal i gitignore. Disse uploades dermed ikke til github? Bruges fx ved dokumenter med personfølsomme data.

## Testing for Git
Dette er en del af øvelsen ved punkt 16. Jeg skal øve at registrere ændringer i git. 

------------ DAG 2 -------------
Punkt 17. 
Skriver kode i console for at downloade data, som er kopieret fra punkt 17.3 på hjemmesiden:
# download.file(
#  url = "https://zenodo.org/records/4989220/files/Eliasson_data2.csv?download=1",
#  destfile = here::here("data/post-meal-insulin.csv")
#)
Dette giver datasættet "post-meal-insulin" i data-mappen. 

Har under "setup" øverst i dokumentet tilegnet dette datasæt navnet: post_meal_data 

Forkortelsen "chr" = characters (bogstaver) og "dbl" (decible?) = tal. Bruges somme tider når datasæt vises (fx ved glimpse-funktion).

Personfølsomme data eller meget store data skal i gitignore!

Hvad skal vises fra code chunks efter render:
"option + i" = |
Man kan vælge, hvad der skal vises i sit render-output. Se hvad jeg har skrevet under "setup"-code chunk øverst i dokumentet: "#| message: false" - default er at den er "true", hvilket betyder, at alle messages vises. Når den skiftes til false, vises ingen beskeder. Det samme gælder for "warning". Dette vil kun gælde for outpus fra denne specifikke code chunk. Man kan gøre sådan, at det gælder for alle code chunks - se dette på undervisningsdokument.



##Showing the data
```{r}
post_meal_data

glimpse(post_meal_data)
```


---- Om at visualisere data - sektion 18 -------

## Plot one continous variable

Undersøger distribution of BMI within diabetes patients: 
aes = æstetik - kan tilskrive "x" at vise en variabelfx BMI
geom siger noget om hvilken type plot, man vil vise
Ved manglende værdier kan man skrive "na.rm=F" = "NA remove = False" - så beholder den datarækker med mangelende værdier. R fjerner automatisk disse ellers.
"fig-cap" giver figure caption under figuren
"label" giver reference i teksten, så hvis man kører musen over denne tekst, vil den vise figuren. 

```{r}
#| fig-cap: "Distribution of BMI"
#| label: fig-bmi-histo
ggplot(post_meal_data, aes(x = BMI)) +
  geom_histogram(na.rm = F)
```
Pga label kan man skrive følgende og referere til figuren:
See @fig-bmi-histo


ØVELSE I SEKTION 18
## Exercise: discrete plots

```{r}
#| fig-cap: "Test plot for glykemi"
#| label: fig-glykemi-bar
ggplot(post_meal_data, aes(x = glykemi)) +
  geom_bar()
```

See @fig-glykemi-bar above for a cool plot!

Ved continous data kan man plotte to variabler (en på hhv x- og y-aksen). Øvelsen herover er afbilledet af "discrete" data med kun en variabel. 

## Plotting to discrete variables
fill vil gerne have chr-inputs, men i dette tilfælde herunder er fill (glykemi) numbers. Derfor ændres til "as.charactor"

```{r}
ggplot(post_meal_data, aes(x = Group, fill = as.character(glykemi))) +
  geom_bar()
```
Koden herover viser barrene i samme kolonner. Hvis man vil skille dem ad kan man skrive følgende i geom_bar-funktionen, så de vises adskilt:

```{r}
ggplot(post_meal_data, aes(x = Group, fill = as.character(glykemi))) +
  geom_bar(position = position_dodge())
```

## Side by side plots
Plotter to plots i samme code chunk med to forskellige variable på x-akserne:
"fig-subcap" giver titler til hver af plots
"layout-ncol" angiver at de skal være side by side. Altså at "number of colums = 2".
```{r fig-bmi-glycemia}
#| fig-cap: "BMI and glycemia, side by side"
#| fig-subcap:
#|  - "Distribution of BMI"
#|  - "Number of those with glycemia"
#| layout-ncol: 2
ggplot(post_meal_data, aes(x = BMI)) +
  geom_histogram()

ggplot(post_meal_data, aes(x = glykemi)) +
  geom_bar()
```


Naming:
R er ligeglad med mellemrum, læses ikke. 

Styling:
Skrev command+shift+p --> "style active file", og så skulle den installere en pakke. Når denne funktion kører, fjerner den de visualiseringer/grafer, vi har lavet, men de kan bare køres igen, så man kan se det. Den justerer teskten i koden og ikke selve plottene, så teksten er pænere/mere overskuelig. 
Dette gjort nu, og der står "using style transformers....." i console, og det skal bruges nu:

## Plotting two continous variables
geom_point giver almindeligt scatter plot

```{r}
ggplot(post_meal_data, aes(x = BMI, y = auc_pg)) +
  geom_point()
```
Ser på plot, at det ligner, at der er en stigning med stigende BMI.

Kan tilføje endnu et lag med "geom_smooth":

```{r}
#| fig-cap: "Scatterplot of BMI and AUC for glucose"
#| label: fig-bmi-auc-pg
ggplot(post_meal_data, aes(x = BMI, y = auc_pg)) +
  geom_point() +
  geom_smooth()
```

----- Section 19 om Github ------
Hjemmeside hvor man kan lægge sit git repository. 
Vær varsom med hvad man lægger ind i git, fordi det kan blive public på github. 
Øvelser herfra gøres i console, fordi ellers kommer alt dette op på github. 
Vi har uploadet projektet til github, tror jeg. 
Vi øver push/pull fra/til github. 

Hvis man vil øve github kan man bruge pakken "saperlipopette" - en slags escaperoom. Sætter et problem op, som skal løses med git og R. 


------ Section 20: Data management and wrangling -----------

## Selecting data med select-function:
Vil gerne se på "age" collum i dataframe "post meal data"-set - se output fra koder nednefor.
Hvis man IKKE vil se en kollonne, skal man skrive "-" (linje 3 i koden herunder). Så viser den de andre kolonner, men ikke den, man har skrevet minus foran. 
Man kan vælge select-funktion til at udvælge særlige kolonner. Fx hvis flere indeholder "insulin", "PG" eller noget andet (linje 4+5+6 herunder) - kan enten udvælges ved at skrive "contains", starts_with" eller "ends_with". Collum names are considered characters (selvom der er tal i) - derfor skal man skrive det i "". 

```{r}
select(post_meal_data, Age)

select(post_meal_data, Age, BMI, Weight)

select(post_meal_data, -Group)

select(post_meal_data, starts_with("PG"))

select(post_meal_data, ends_with("DXA"))

select(post_meal_data, contains("0"))
```


Vi vil nu lave en ny variabel/dataframe i datasættet. Kommer ud i environment og laver nyt datasæt med de variable, som man vælger. 
I undervisningen skriver de denne linje under "setup" chunk (har jeg også gjort) - gør dette ved eget datasæt, fordi denne altid kører som noget af det første, når man arbejder i programmet. 
Kører denne i setup: "small_post_meal_data <- select(post_meal_data, id, Age, BMI, Group, auc_pg, auc_ins, glykemi)"

## Renaming Columns
rename er en funktion, der kan omdøbe kolonner.
Disse to pipes gør helt det samme: |> og %>%
Pipen siger "within this dataframe" som man har skrevet forud (se herunder).
Rename: Skriv nyt navn FØRST og originalt navn SIDST.

```{r}
small_post_meal_data |>
  rename(
    auc_glucose = auc_pg,
    auc_insulin = auc_ins
  )
```

## Exercise 20.6 - Select and rename tasks:

```{r}
# Task 1.
# select() only columns that contain() the text "OGTT". Run that code to get the output. How many columns are there?
post_meal_data |>
  select(contains("OGTT"))
# Svar: tibble med 31x13

# Task 2.
# select() columns that contains() the characters ".." but exclude - columns that contains() the characters "...".
post_meal_data |>
  select(contains(".."), -contains("..."))
# Får tibble 31x2

# Task 3.
# Based on the columns from task 2 above, use rename() on those columns so that the .. inside their name is .minus. You will need to type out these column names, both the old and the new, manually. Recall that renaming is in the form new = old.
post_meal_data |>
  rename(
    P.Glucose.minus5.OGTT = P.Glucose..5.OGTT,
    Insulin.minus5.OGTT.X = Insulin..5.OGTT.X
  )

# Task 4.
# Read through (in your head) the code below # Task 4. above. How intuitive is it to read? Now, re-write this code to use the pipe |> so that you don’t need to create the temporary basic_info object, then re-read the revised version. Which do you feel is easier to “read”?
basic_info <- select(post_meal_data, id, BMI, Length, Weight, Age)
rename(basic_info, Height = Length)
# Omskrevet:
post_meal_data |>
  select(id, BMI, Length, Weight, Age) |>
  rename(Height = Length)
```

------- Filtering data by row med filter-funktion ------------

##Filtering data med filter-funktion 
Om kodeblokken herunder:
Linje 1: Vil finde deltagere med glykemi = 1 (præcis 1) (vises som == i kode). Koden herunder siger, at hvis glykemi = 1, skal de beholdes - alle andre fjernes. 
Linje 2: Kun rækker med BMI større end eller lig med 25.
Linje 3: Vil kun se alle i kontrolgruppen. Skriver i "" fordi der er tale om tekst-kolonne.
Linje 4: Want people who are in control group AND BMI > 25. Komma i denne sammenhæng betyder "and".
Linje 5: Samme som linje 4, men med "eller" i stedet for "and". Giver self flere rækker, fordi det er "eller" og ikke "og". 

```{r}
small_post_meal_data |>
  filter(glykemi == 1)

small_post_meal_data |>
  filter(BMI >= 25)

small_post_meal_data |>
  filter(Group == "CTR")

small_post_meal_data |>
  filter(Group == "CTR", BMI >= 25)

small_post_meal_data |>
  filter(Group == "CTR" | BMI >= 25)
```

Gør sådan at de omdøbte kolonner kommer i datasættet og ikke bare outputtet. Gøres i setup-chunk. Gør dette i setup-chunk i eget datasæt også - sikrer at ændringerne indlæses som noget af det første. Omdøber nogle af tingene i det lille datasæt. Det er koden, der starter med "tidier" - se evt under "setup" øverst.

## Modifying data med mutate-funktion:
Man kan fx opdele kolonner eller lægge et tal til alle kolonner. 
You can use mutate() to compute a new column using existing columns in your dataset. You can multiply all values in a certain column by 2, or combine columns into a new column.
Linje 1 herunder: Opretter ny kolonne "insulin_glucose_ratio" med mutate-funktionen. Skriver hvad kolonnen skal hedde og derefter, hvad den skal bestå af (altså auc_insulin divideret med auc_glucose). 
Koden siger "Tag dette datasæt - vil mutate  og lave ny kolonne, som skal bestå af dette regnestykke".

Linje 2: Modify existing collum. Komma adskiller de forskellige ting, mutate-funktionen skal gøre. Vil modify "group"-kolonne med "if_else"-funktion - siger at hvis dette indenfor denne specifikke kollone er sandt (altså at der står "CTR"), så skrift til dette (=control), og hvis IKKE det er sandt, skal der stå "first degree relative". Der skal altid stå tre ting efter denne "if_else"-funktion, fordi den kører efter denne logik. 

Den nederste linje (2) indsættes under "setup" for at have et opdateret datasæt, som er "tidied". Dette er navngivet "tidied_post_meal_data" - se under setup. Giver nyt datasæt, som kan ses i environment.

```{r}
tidier_post_meal_data |>
  mutate(insulin_glucose_ratio = auc_insulin / auc_glucose)

tidier_post_meal_data |>
  mutate(
    insulin_glucose_ratio = auc_insulin / auc_glucose,
    Group = if_else(Group == "CTR", "Control", "First degree relative")
  )
```

## Practice with filter and mutate - øvelse i sektion 20

#Task 1:
Use filter() to find how many participants have a BMI of more than or equal to 25 and less than or equal to 40, and are in the “FDR” Group. How many are there?

#Task 2:
Create a percent_body_fat column with mutate() by dividing the Fat.mass.DXA by the Weight, then multiplying by 100. Hint: In R, use * to multiply and / to divide. Then pipe to filter() to find out how many participants have a percent_body_fat greater than 30.

```{r}
# Task 1:
post_meal_data |>
  filter(BMI >= 25 & BMI <= 40 & Group == "FDR")
# Får 8x85 tabel. Således 8 der opfylder disse kriterier.

# Task 2:
post_meal_data |>
  mutate(
    percent_body_fat = (Fat.mass.DXA / Weight) * 100
  ) |>
  filter(percent_body_fat > 30)
# 10 personer har percent_body_fat > 30.
```

------ Sektion 21: Wrangling with visualizing --------

## Visualizing  with jitter plot 

Vil visualisere 
Med denne linje: " mutate(overweight = BMI >= 25, "overweight", "not overweight")" siger vi, at vi laver en ny kolonne med overweight/not overweight, hvor kravet er, at BMI >= 25 - funktionen siger, at hvis dette er sandt, skal de navngives "overweight" og ellers "not overweight".
ggplot-linjen siger hvordan plottet skal være (på x- og y-aksen). "+geom_jitter" giver punkterne i grafen - jitter-koden giver forskellige plots hver gang, man kører den - lægger den random, fordi de ellers ville ligge i en linje. Kan også køre "geom_boxplot" eller "geom_violin" - man kan lave flere plots oveni hinandne ved at skrive "+" imellem dem som herunder. Her er plottet to variable.


```{r}
tidied_post_meal_data |>
  mutate(overweight = if_else(BMI >= 25, "Overweight", "Not overweight")) |>
  ggplot(aes(x = overweight, y = insulin_glucose_ratio)) +
  geom_jitter() +
  geom_boxplot()
```

## Plotting three or more variables

An "input argument".
Nedenstående plot viser også hvordan man tilføjer farve. 

```{r}
tidied_post_meal_data |>
  filter(BMI < 30) |>
  ggplot(aes(x = Age, y = auc_insulin, colour = Group)) +
  geom_point()
```
Laver nyt plot, hvor man deler på på "unge" og "gamle" med aldersskel 40 år.
Bruger + når man har skrevet ggplot, fordi man ikke kan pipe i den funktion.

facet_grid() splits the plot up into multiple subplots. For faceting to work, at least one of the first two arguments to facet_grid() is needed. The first two arguments are:
cols: The discrete variable to use to facet the plot column-wise (i.e. side-by-side).
rows: The discrete variable to use to facet the plot row-wise (i.e. stacked on top of each other).

Undervejs i øvelsen ændres "Age" til BMI indeni koden. Ser BMI-plot herunder. Har fire dimentioner af information (alder, BMI, auc_insulin og group).

```{r}
tidied_post_meal_data |>
  filter(BMI < 30) |>
  mutate(young = if_else(Age < 40, "Young", "Old")) |>
  ggplot(aes(x = BMI, y = auc_insulin, colour = Group)) +
  geom_point() +
  facet_grid(cols = vars(young))
```

Ændrer cols --> rows for at se, hvordan det ser ud:

```{r}
tidied_post_meal_data |>
  filter(BMI < 30) |>
  mutate(young = if_else(Age < 40, "Young", "Old")) |>
  ggplot(aes(x = BMI, y = auc_insulin, colour = Group)) +
  geom_point() +
  facet_grid(rows = vars(young))
```
Adder labels:
Og ændrer auc_insulin til insulin_glucose_ratio (giver mere mening klinisk, men ligemeget for kodelæring).

```{r}
tidied_post_meal_data |>
  filter(BMI < 30) |>
  mutate(young = if_else(Age < 40, "Young", "Old")) |>
  ggplot(aes(x = BMI, y = insulin_glucose_ratio, colour = Group)) +
  geom_point() +
  facet_grid(rows = vars(young)) +
  labs(
    x = "Body mass index (BMI)",
    y = "Insulin to glucose ratio"
  )
```
